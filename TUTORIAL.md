# netsert Tutorial

A hands-on guide to using netsert with Arista cEOS and Containerlab.

By the end of this tutorial, you'll:
- Deploy a network lab
- Query device state with gNMI
- Generate assertions from live devices
- Run assertions and interpret results
- Integrate with CI/CD pipelines

**Time required:** ~15 minutes

---

## Prerequisites

- Docker installed and running
- Go 1.22+ installed
- [Containerlab](https://containerlab.dev) installed
- Arista cEOS image imported (free from arista.com)

### Import cEOS image

```bash
# Download cEOS-lab from arista.com (free account required)
# Then import:
docker import cEOS64-lab-4.32.3F.tar.xz ceos:4.32.3F
docker tag ceos:4.32.3F ceos:latest
```

---

## Step 1: Clone and Build

```bash
git clone https://github.com/ndtobs/netsert.git
cd netsert

# Build the binary
go build -o netsert ./cmd/netsert

# Verify it works
./netsert --version
```

---

## Step 2: Set Up Credentials

Create a config file so you don't have to pass credentials every time:

```bash
cp examples/netsert.yaml .
```

This creates `netsert.yaml` in your current directory with:

```yaml
defaults:
  username: admin
  password: admin
  insecure: true  # Skip TLS verification (lab only!)
```

> **Note:** For production, use per-target credentials and proper TLS. See [Configuration](#configuration) in the README.

---

## Step 3: Deploy the Lab

```bash
cd examples/lab
sudo containerlab deploy -t topology.yaml
cd ../..
```

This creates a 3-node network:

```
        ┌─────────┐
        │ spine1  │
        │ AS65000 │
        └────┬────┘
           ╱   ╲
     eth1 ╱     ╲ eth2
         ╱       ╲
   ┌────┴──┐   ┌──┴────┐
   │ leaf1 │   │ leaf2 │
   │AS65001│   │AS65002│
   └───────┘   └───────┘
```

Wait ~30 seconds for devices to boot, then verify:

```bash
docker ps | grep netsert
```

You should see three containers running.

---

## Step 4: Explore with `get`

Before writing assertions, explore what data is available:

```bash
# Check hostname (full path)
./netsert get clab-netsert-spine1:6030 /system/config/hostname
```

Output:
```
Path: /system/config/hostname
Value: spine1
```

```bash
# Check interface status (full path)
./netsert get clab-netsert-spine1:6030 /interfaces/interface[name=Ethernet1]/state/oper-status
```

Output:
```
Path: /interfaces/interface[name=Ethernet1]/state/oper-status
Value: UP
```

```bash
# Get full interface state as JSON (great for discovering paths)
./netsert get -o json clab-netsert-spine1:6030 /interfaces/interface[name=Ethernet1]/state
```

> **Note:** The `get` command uses full OpenConfig paths. When writing assertions, you can use [short paths](#short-paths) for convenience.

---

## Step 5: Configure BGP (Optional)

To test BGP assertions, configure BGP on the devices:

```bash
# Spine1
docker exec clab-netsert-spine1 bash -c 'echo -e "configure\nrouter bgp 65000\nrouter-id 10.255.0.1\nneighbor 10.0.1.2 remote-as 65001\nneighbor 10.0.2.2 remote-as 65002" | Cli -p 15'

# Leaf1
docker exec clab-netsert-leaf1 bash -c 'echo -e "configure\nrouter bgp 65001\nrouter-id 10.255.1.1\nneighbor 10.0.1.1 remote-as 65000" | Cli -p 15'

# Leaf2
docker exec clab-netsert-leaf2 bash -c 'echo -e "configure\nrouter bgp 65002\nrouter-id 10.255.2.1\nneighbor 10.0.2.1 remote-as 65000" | Cli -p 15'
```

Verify BGP is up:

```bash
docker exec clab-netsert-spine1 Cli -p 15 -c 'show ip bgp summary'
```

Output:
```
BGP summary information for VRF default
Router identifier 10.255.0.1, local AS number 65000
  Neighbor V AS           MsgRcvd   MsgSent  InQ OutQ  Up/Down State   PfxRcd PfxAcc
  10.0.1.2 4 65001              4         3    0    0 00:00:05 Estab   0      0
  10.0.2.2 4 65002              2         2    0    0 00:00:00 Estab   0      0
```

---

## Step 6: Generate Assertions

Instead of writing assertions by hand, generate them from the live device:

```bash
# Generate all (interfaces + BGP)
./netsert generate clab-netsert-spine1:6030
```

Output:
```yaml
# Generated by netsert from clab-netsert-spine1:6030
# Review and edit as needed

targets:
    - host: clab-netsert-spine1:6030
      assertions:
        - name: Ethernet1 is UP
          path: interface[Ethernet1]/state/oper-status
          equals: UP
        - name: Ethernet2 is UP
          path: interface[Ethernet2]/state/oper-status
          equals: UP
        - name: BGP peer 10.0.1.2 is ESTABLISHED
          path: bgp[default]/neighbors/neighbor[neighbor-address=10.0.1.2]/state/session-state
          equals: ESTABLISHED
        - name: BGP peer 10.0.2.2 is ESTABLISHED
          path: bgp[default]/neighbors/neighbor[neighbor-address=10.0.2.2]/state/session-state
          equals: ESTABLISHED
```

> **Note:** Generated paths use the [short path format](README.md#short-paths) for readability. They expand automatically to full OpenConfig paths at runtime.

Save to a file:

```bash
./netsert generate clab-netsert-spine1:6030 -f baseline.yaml
```

You can also generate specific features:

```bash
./netsert generate clab-netsert-spine1:6030 --gen interfaces
./netsert generate clab-netsert-spine1:6030 --gen bgp
```

---

## Step 7: Run Assertions

Now run the assertions against the live device:

```bash
./netsert run baseline.yaml
```

Output:
```
Running assertions from baseline.yaml

✓ [PASS] Ethernet1 is UP @ clab-netsert-spine1:6030
✓ [PASS] Ethernet2 is UP @ clab-netsert-spine1:6030
✓ [PASS] BGP peer 10.0.1.2 is ESTABLISHED @ clab-netsert-spine1:6030
✓ [PASS] BGP peer 10.0.2.2 is ESTABLISHED @ clab-netsert-spine1:6030

Completed in 53ms
  Total:  4
  Passed: 4
  Failed: 0
```

### Verbose mode

See actual vs expected on failures:

```bash
./netsert run -v baseline.yaml
```

### JSON output

For CI/CD integration:

```bash
./netsert run -o json baseline.yaml
```

Output:
```json
{
  "summary": {
    "file": "baseline.yaml",
    "total": 4,
    "passed": 4,
    "failed": 0,
    "errors": 0,
    "duration": "53ms",
    "success": true
  },
  "results": [...]
}
```

---

## Step 8: Simulate a Failure

Let's break something and see how netsert catches it:

```bash
# Shut down an interface
docker exec clab-netsert-spine1 bash -c 'echo -e "configure\ninterface Ethernet1\nshutdown" | Cli -p 15'

# Run assertions again
./netsert run -v baseline.yaml
```

Output:
```
Running assertions from baseline.yaml

✗ [FAIL] Ethernet1 is UP @ clab-netsert-spine1:6030
    actual: DOWN
    expected: UP
✗ [FAIL] BGP peer 10.0.1.2 is ESTABLISHED @ clab-netsert-spine1:6030
    actual: ACTIVE
    expected: ESTABLISHED
✓ [PASS] Ethernet2 is UP @ clab-netsert-spine1:6030
✓ [PASS] BGP peer 10.0.2.2 is ESTABLISHED @ clab-netsert-spine1:6030

Completed in 51ms
  Total:  4
  Passed: 2
  Failed: 2
```

Check the exit code:

```bash
echo $?
# Output: 1  (failure)
```

Restore the interface:

```bash
docker exec clab-netsert-spine1 bash -c 'echo -e "configure\ninterface Ethernet1\nno shutdown" | Cli -p 15'
```

---

## Step 9: Run Unit Tests

```bash
go test ./...
```

Output:
```
ok  	github.com/ndtobs/netsert/pkg/assertion   0.002s
ok  	github.com/ndtobs/netsert/pkg/gnmiclient  0.002s
```

---

## Step 10: Clean Up

```bash
# Destroy the lab
cd examples/lab
sudo containerlab destroy -t topology.yaml
cd ../..

# Remove config file if desired
rm netsert.yaml baseline.yaml
```

---

## Next Steps

- **Add more devices:** Edit `examples/lab/topology.yaml` to add more nodes
- **Write custom assertions:** See assertion types in README.md
- **CI/CD integration:** Use JSON output in GitHub Actions or GitLab CI
- **Add generators:** Create new generators in `pkg/generate/` for other features

---

## Quick Reference

```bash
# Set up (run once)
cp examples/netsert.yaml .

# Explore a device
./netsert get <target> <path>
./netsert get -o json <target> <path>

# Generate assertions from live state
./netsert generate <target>
./netsert generate <target> --gen bgp
./netsert generate <target> -f output.yaml

# Run assertions
./netsert run assertions.yaml
./netsert run -v assertions.yaml      # verbose
./netsert run -o json assertions.yaml # JSON for CI

# Validate syntax only
./netsert validate assertions.yaml
```

---

## Troubleshooting

### "connection error: transport: authentication handshake failed"

The device expects plain gRPC but client is trying TLS (or vice versa).

**Fix:** Add `insecure: true` to config or use `-k` flag:
```bash
./netsert get -k clab-netsert-spine1:6030 /system/config/hostname
```

### "failed to extract username"

Credentials not provided.

**Fix:** Create config file or use `-u`/`-P` flags:
```bash
./netsert get -k -u admin -P admin clab-netsert-spine1:6030 /system/config/hostname
```

### "connection refused"

Device not reachable or gNMI not enabled.

**Fix:** Check device is running and gNMI is configured:
```bash
docker exec clab-netsert-spine1 Cli -p 15 -c 'show management api gnmi'
```

### "path not found"

The gNMI path doesn't exist on this device/platform.

**Fix:** Use `get` to explore available paths:
```bash
./netsert get -o json clab-netsert-spine1:6030 /interfaces
```
